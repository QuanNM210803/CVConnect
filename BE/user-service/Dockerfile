FROM maven:3.9-eclipse-temurin-17 AS build

WORKDIR /app

COPY . .
COPY settings.xml /root/.m2/settings.xml
RUN mvn clean package -pl user-service -am -DskipTests spring-boot:repackage

FROM eclipse-temurin:17-jdk

WORKDIR /app

COPY --from=build /app/user-service/target/user-service-1.0-SNAPSHOT.jar app.jar

ARG KAFKA_HOST
ARG KAFKA_PORT
ARG DB_HOST
ARG HOST_USER_SERVICE
ARG PORT_USER_SERVICE
ARG HOST_NOTIFY_SERVICE
ARG PORT_NOTIFY_SERVICE
ARG HOST_CORE_SERVICE
ARG PORT_CORE_SERVICE
ARG HOST_SOCKET
ARG PORT_SOCKET
ARG HOST_REDIS
ARG PORT_REDIS
ARG FRONTEND_URL

ENV KAFKA_HOST=${KAFKA_HOST}
ENV KAFKA_PORT=${KAFKA_PORT}
ENV DB_HOST=${DB_HOST}
ENV HOST_USER_SERVICE=${HOST_USER_SERVICE}
ENV PORT_USER_SERVICE=${PORT_USER_SERVICE}
ENV HOST_NOTIFY_SERVICE=${HOST_NOTIFY_SERVICE}
ENV PORT_NOTIFY_SERVICE=${PORT_NOTIFY_SERVICE}
ENV HOST_CORE_SERVICE=${HOST_CORE_SERVICE}
ENV PORT_CORE_SERVICE=${PORT_CORE_SERVICE}
ENV HOST_SOCKET=${HOST_SOCKET}
ENV PORT_SOCKET=${PORT_SOCKET}
ENV HOST_REDIS=${HOST_REDIS}
ENV PORT_REDIS=${PORT_REDIS}
ENV FRONTEND_URL=${FRONTEND_URL}

EXPOSE ${PORT_USER_SERVICE}

ENTRYPOINT ["java", "-jar", "app.jar"]